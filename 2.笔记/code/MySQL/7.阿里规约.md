###  1.索引选择性陷阱
##### 页面搜索严谨左模糊或全模糊，如果需要请求搜索引擎解决。
索引文件具有B+树的最左前缀匹配特性，如果左边的值未确定，则无法使用该索引。
- 什么是索引选择性陷阱？就是建立了索引，但是查询依然走全表，也就是索引失效。
- 因此B+树的非聚簇索引如果是非数字的情况下，会按照字母表的顺序排列，如果是左模糊或者全模糊，那么去一个个去匹配。
- 那么右模糊就100%没问题吗，也不是。比如你查询手机号 like 133%可能没问题，但是如果是like 1%依然可能会触发全表扫描，因为手机号全是1开头的，此时优化器就会判断可能不如直接走全表扫描，相同的例子还有当查询性别时，如果几乎全是同一种性别，没有区分度也可能会触发全表扫描。查询医院中护士性别为女的查询。

##### 如何解决索引选择性差的问题。
- 根据业务使用组合索引，提高分辨率
- 引入其他搜索引擎如ES，将护士表导入ES，采用分片多线程检索，解决慢查询的问题。
- 强制使用索引`select * from question force index(answer) where answer = 'A'`
- 增加缓存
```
innodb_buff_pool_size = 16G
innodb_buff_pool_instance = 2
```

### 2.为什么禁用外键约束
- 不得使用外键与级联，一切与外键相关的概念都在应用层解决。
- 什么是外键约束？简单的说，就是删除主键表时，必须删除与之相关的其他表。
- 为什么禁用？
1. 每次删除或更新时都必须考虑外键约束，开发比较麻烦，测试数据极为不方便。
2. 数据一致性查询时损耗性能，比如插入修改订单明细表，还要查询订单表是否存在。
3. 并发问题：外键约束会启用行级锁，主表写入时会处于阻塞状态。如一个订单买了十几样商品，此时会有十几个订单明细表，写入订单明细表时，会检查订单id是否存在，此时会触发共享锁（也就是读锁）。如果此时有人需要修改订单表也就持有了排他锁（写锁），如果写锁不被释放，所有的订单明细就无法读取，此时所有的订单明细要写都要进行等待。
4. 级联删除会使数据变得不可控，因此触发器也要被严格禁用。如数据类型字典，订单表中有数据类型外键，订单明细表中又有订单表外键，此时如果删除数据类型，假如表的关联很长，就会导致许多表数据被级联删除。
5. 数据耦合，数据库层面数据产生耦合，数据迁移困难。


### 3.禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。
1. 为什么银行都在用存储过程？

![[银行存储过程.png]]
银行的业务：每天完成可能会定期使用ETL与抽取业务源数据，再使用存储过程存进数据仓库。
银行业务以数据为核心，且数据库全是DB2和oracle，其存储过程与语言无关。
3. 为什么互联网行业禁用存储过程？
- 银行IT去国外化，使用国产数据库。银行被DB2、oracle绑架。存储过程无法迁移。存储过程全部要重写，一旦重写，核心业务的风险出问题不可想象。
- 存储过程会与数据库绑定，无法迁移。
- 互联网分布式场景，存储过程无法解决。
    - 分片场景下（如数据库水平分割，一个表分成多个子表）存储过程只能作用于局部数据。
    - 存储过程可能会使数据库压力激增。
    - 无法保证分布式事务全局事务。
- 存储过程难以调试，没有内置的版本管理工具。
- 业务执行碎片化
![[存储过程业务执行碎片化.png]]
### 4.为什么禁用三表join关联查询
- 超过三个表禁止join；需要join的关键字数据类型必须一致；多表关联查询时，保证被关联的字段有索引。
- 为什么要禁用多表关联？
        - MySQL自身具有设计缺陷，多表查询时，SQL优化器做的不好，NLJ多级嵌套性能差。
            ![[NLJ多级嵌套性能差.png]]
            采用小表关联大表，但是发现小表需要动态计算找出，三表以上时计算量激增
    - 依赖数据源特性获取数据，数据迁移改造困难。业务体量变大，数据量变大，可能需要分库分表（此时关联查询也会有问题），不同的数据可能放在不同的库中了。此时就需要从商品库发请求到订单库获取信息，此时如果是按照关联查询，那么需要改动很多的代码。
- 出现多表关联时，解决方案有哪些？
    - 临时解决，适合数据量小，只适合inner join

```
select * from a where
select * from b where aid in()
select * from c where bid in()
```     
- 反范式表--较常见，特别适合单库处理。
    ![[反范式表.png]]
    关联的表仍然正常存储，在关联表的数据有修改新增删除时，同步去操作反范式表。查询时只需要查询反范式表即可。特别适合单库处理。
    
    - 数据仓库与数据集市

![[数据仓库与数据集市.png]]
通过ETL抽取数据源处理，再导入到数据集市（各种表格、中间表等）。