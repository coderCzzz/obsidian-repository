**InnoDB引擎下讨论**

先分析表的组成：表分为表结构定义和数据。8.0以前，表结构存在以`.frm`为后缀的文件中。8.0中将表结构定义放在系统数据表中，表结构定义占用的空间很小，因此主要看表数据。

#### 参数`innodb_file_per_table`
该参数控制表数据存共享表中还是单独的文件。
off表示数据放在系统共享表空间，也就是跟数据字典放在一起。
on表示每个innodb表数据存储在一个以.ibd为后缀的文件中。 5.6.6后默认值为on。
推荐设置为on。这样当你不需要这个表通过`drop table`删除时，系统会直接删除这个文件。而如果放在共享表空间中，即使表删除了，空间也是不会回收的。

#### 数据删除流程
删除整个表时，`drop table`会回收表空间。但是删除某些行时，表中的数据被删除了，表空间却没有被回收。
- 记录的复用：删除一个记录，InnoDB引擎会把这个记录标记为删除，如果后面插入一个在符合条件之间的记录，可能会复用这个位置，但是磁盘文件大小并不会缩小。
- 数据页的复用：如果我们删除了一个数据页上的所有数据，整个数据页就可以被复用。
- 记录与数据页复用差异
    - 记录的复用只限于符合范围条件的数据。
    - 数据页被删除后，可以复用到任何位置。如果相邻的两个数据页利用率很小，系统就会把这两个页上的数据合到其中一个页上，另一个数据页被标记为可复用。
    - 因次如果我们用delete命令将整个表的数据删除，所有的数据页都会被标记为可复用，但是磁盘上，文件不会变小。
  
  - 插入数据也会造成空洞： 如果数据随机插入，就可能造成索引的数据页分裂。
  - 更新索引上的值，可以理解为删除一个旧的值，再插入一个新的值，也会造成空洞
  - 经过大量增删改的表，都有可能存在空洞。而重建表，可以达到收缩表空间的目睹。

#### 重建表
- 操作
    - 新建一个与表A结构相同的表B，按照主键ID递增的顺序，把数据一行一行的从表A读出来插入到表B。
    - 可以使用命令`alter table A engine = InnoDB`重建表。5.5版本前这个命令的执行和上述描述差不多。这种过程中，有新的数据要写入到表A就会造成数据丢失，因此整个DDL过程中，表A中不能有更新，也就是说这个DDL过程不是Online的。
    - 5.6版本后引入了Online DDL
        1. 新建一个临时文件，扫描表A主键的所有数据页。
        2. 用数据页中表A的记录生成B+树，存储到临时文件中。
        3. 生成临时文件的过程中，将所有对A的操作记录在一个日志文件(row log)中，对应是图中的state2状态
        4. 临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表A相同的数据文件，对应的就是图中state3的状态
        5. 用临时文件替换A的数据文件。

![[优化的Online DDL.png]]
- DDL是需要拿MDL写锁的。
    - later语句启动的时候需要获取MDL写锁。
    - 在拷贝数据之前，退化程读锁，因为读锁不会阻塞园表的增删改操作。
    - 也不能直接解锁，禁止其他线程对这个表同时做DDL。
    - Online DDL最耗时的是拷贝数据到临时表，这个步骤执行期间可以接受增删改，因此，整个DDL过程中，锁的时间非常短，对于业务来说，可以认为是Online的。
 - 上述重建方法都会扫描原表数据和构建临时文件，对于很大表，很消耗IO和CPU资源，因此最好使用GitHub开源的`gh-ost`做。


#### Online和inplace的区别
- 非OnlineDDL时，表A中的数据导出来存放位置是`tmp_table`，这是一个临时表，在`Server`层创建。
- Online DDL时，根据表A重建出来的数据放在`tmp_file`中，这个临时文件是`InnoDB`在内部创建出来的。整个DDL过程在`InnoDB`内部完成。对于Server层来说，没有把数据挪动到临时表，是一个原地操作，这个概念叫inplace。
- 因此如果有一个1TB的表，磁盘空间是1.2TB，不能做inplace的DDL。因为`tmp_file`也要占用临时空间。
- 重建表的语句`alter table t engine = InnoDB`，隐含意思是`alter table t engine=innodb, ALGORITHM=inplace`,与之对应的就是拷贝表的方法`alter table t engine=innodb, ALGORITHM=copy`。

#### optimize table、analyze table、alter table的区别
- alter table也就是recreate默认就是Online模式的重建表
- analyze table不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程加了MDL读锁
- optimize table t等于recreate+analyze。


