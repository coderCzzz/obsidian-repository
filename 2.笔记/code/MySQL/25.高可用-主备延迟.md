#### 主备延迟
##### 主动切换流程
与数据同步有关的时间点主要包括一下三个：
1. 主库A执行完成一个事务，写入binlog，我们把这个时刻记为T1
2. 之后传给备库B，我们把备库B接收完这个binlog的时刻记为T2
3. 备库B执行完成这个事务，我们把这个时刻记为T3

主备延迟，就是同一个事务，在备库执行完成的时间和主库执行完成的时间之差：T3-T1
可以在备库上执行`show slave status`命令，它的返回结果里面显示的`seconds_behind_master`用于表示当前备库延迟了多少秒
`seconds_behind_master`的计算方法如下：
1. 每个事务的binlog里面都有一个时间字段，用于记录主库上写入的时间
2. 备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时间的差值就得到`seconds_behind_master`

网络正常的时候，日志从主库传到备库所需的时间是很短的，即T2-T1.即主备延迟的主要来源是备库接收完binlog和执行完这个事务之间的时间差。
主备延迟最直接的表现是：备库消费中转日志的速度比主库生产binlog的速度要慢。

#### 主备延迟的来源
- 某些部署情况下，备库所在机器的性能比主库所在机器的性能差

- 做了对称部署时，此时可能就是备库的压力大
解决：
1. 一主多从。
2. 通过binlog输出到外部系统，比如Hadoop这类系统，让外部系统提供统计类查询的能力。

- 大事务
    - 大事务的场景：1.批量删除大量数据   2.大表DDL
- 备库的并行复制能力

#### 可靠性优先策略
双M结构下，主从切换的详细过程如下：
1. 判断备库B现在的`seconds_behind_master`，如果小于某个值，继续下一步，否则持续重试这一步
2. 把主库A改成只读状态
3. 判断备库B的`seconds_behind_master`的值，直到这个值变成0为止
4. 把备库B改成可读写状态
5. 把业务请求切到备库B

该切换流程，一般由专门的HA系统完成。

#### 可用性优先策略
将4、5调整到最开始执行，这个流程称为可用性优先策略
该策略可能会出现数据不一致的情况
