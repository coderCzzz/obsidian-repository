## 为什么要主从复制
`Redis`虽然读写都很快，但是也会面临读压力特别大的情况。采用一主多从或级联结构来降低读压力。

## Redis主从复制概述
Redis主从复制根据是否是全量分为全量同步和增量同步。

### 全量同步
- 全量复制一般发生在`Slave`初始化阶段，这时`Slave`将`Master`上所有数据都复制一份。具体步骤如下：
	- 从服务器连接到主服务器，发送`SYNC`命令
	- 主服务器接收到`SYNC`命令，开始执行`BESAVE`命令生成`RDB`文件并使用缓冲区记录此后执行的所有写命令。
	- 主服务器`BESAVE`命令执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令。
	- 从服务器收到快照后丢弃所有旧数据，载入收到的快照。
	- 主服务器快照发送完毕后开始向从服务器发送缓冲区的写命令。
	- 从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令
- 完成以上步骤后，从服务器可以接收来自用户的读请求。
- 为了提高数据同步操作的执行效率，如果主服务器在接收到REPLICAOF命令之前已经完成了一次RDB创建操作，并且它的数据库在创建RDB文件之后没有发生过任何变化，那么主服务器将直接向从服务器发送已有的RDB文件，以此来避免无谓的RDB文件生成操作。

### 增量同步（在线更新）
- 执行完全量同步后，每当主服务器执行了新的写命令，就需要与从服务器进行同步
- `Redis`增量同步发生在从服务器初始化后开始正常工作时，主服务器发生的写操作同步到从服务器的过程。
- 主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并开始执行收到的写命令。

### 注意
- 如果多个从服务器宕机重启。因为从服务器启动就会发送`sync`请求和主服务器全量同步，此时可能会导致主服务器IO剧增。
- 主从复制不会阻塞主服务器，也不会阻塞从服务器。
- 需要注意的是，因为在线更新是异步进行的，所以在主服务器执行完写命令之后，直到从服务器也执行完相同写命令的这段时间里，主从服务器的数据库将出现短暂的不一致，因此要求强一致性的程序可能需要直接读取主服务器而不是读取从服务器。

### 无磁盘复制
- 一个完全重新同步需要在磁盘上创建一个`RDB`文件，然后加载这个文件以便为从服务器发送数据。
- 但是如果主服务器磁盘传输速度过低或磁盘空间不够大，就会有问题。
- 无磁盘复制直接将`RDB`通过网络发送给服务器，不使用磁盘作为中
- 设置`repl-diskless-sync yes`
- 无须硬盘的复制特性只是避免了在主服务器上创建RDB文件，但仍然需要在从服务器上创建RDB文件。

## 如何设置
### 将服务器设置为从服务器
- 命令：5.0.0之前使用`SLAVEOF`，5.0开始使用`REPLICAOF`将接收这个命令的`Redis`服务器设置为另一个`Redis`服务器的从服务器（谁执行这个命令谁是从）
```
REPLICAOF host port   #host port指定主服务器的ip地址、端口号
```
- 通过设置`replicaof`配置选项
	- 在启动`Redis`服务器同时将它设置为从服务器
	- `redis-server --port 10086 --replicaof 127.0.0.1 6379`

### 取消复制
- 命令：`REPLICAOF no one`,停止后不会清除数据库

### 其他命令
- `ROLE`查看服务器当前担任的角色
	- 在主服务器上执行，返回3个元素组成的数组
		- 第一个master
		- 表示主服务器的复制偏移量，就是目前发送了多少数据
		- 数组，记录了所有从服务器。其中每个数组元素由3个子元素组成：ip地址、端口、从服务器的复制偏移量
	- 在从服务器上
		- slave
		- 2、3元素记录主服务器的ip、端口号
		- 主从连接状态
		- 从服务器当前的复制偏移量
